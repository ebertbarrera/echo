name: Repair & Resume Agent (Crash-Safe)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "GitHub issue number to run (e.g., 123)"
        required: true
      branch_name:
        description: "Feature branch to (re)create"
        required: true
        default: "feat/lease-exec-bundle"

concurrency:
  group: repair-resume
  cancel-in-progress: true

jobs:
  repair_and_resume:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0, clean: true }

      - name: Git safety & identity
        run: |
          git config --global safe.directory '*'
          git config --global user.email "agent@local"
          git config --global user.name "AI Agent"

      - name: Create/reset feature branch
        run: git checkout -B "${{ inputs.branch_name }}"

      - name: Add crash-safe checkpoint script
        run: |
          mkdir -p scripts
          cat > scripts/checkpoint.sh <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          msg="${1:-checkpoint}"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "$msg"
            git push -u origin HEAD || true
          fi
          SH
          chmod +x scripts/checkpoint.sh
          ./scripts/checkpoint.sh "chore: add checkpoint script"

      - name: Setup Python (for OpenHands)
        uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Install OpenHands
        run: |
          python -m pip install --upgrade pip
          pip install openhands

      - name: Run Agent on the specified issue (commit-as-you-go)
        env:
          OPENAI_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ./scripts/checkpoint.sh "chore: pre-run checkpoint"
          openhands run \
            --repo-path . \
            --task-source "github_issue:${{ github.repository }}:${{ inputs.issue_number }}" \
            --model "${{ vars.LLM_MODEL || 'openai/gpt-4o-mini' }}" \
            --max-iterations "${{ vars.OPENHANDS_MAX_ITER || '8' }}" \
            --commit-pr
          ./scripts/checkpoint.sh "chore: post-run checkpoint"

      - name: If failure, still open a status issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const msg = `Repair & Resume failed for issue #${{ inputs.issue_number }}. Partial commits may have been pushed to \`${{ inputs.branch_name }}\`. Please review run logs.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "[NOTICE] Repair & Resume encountered a failure",
              body: msg,
              labels: ["agent:retry","bug","priority:high"]
            });
